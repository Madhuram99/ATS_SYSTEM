{% extends "base.html" %}

{% block title %}{{ candidate.first_name }} {{ candidate.last_name }} - ATS System{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{% url 'candidate_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Candidates
    </a>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title mb-0">{{ candidate.first_name }} {{ candidate.last_name }}</h3>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    <strong>Email:</strong> {{ candidate.email }}<br>
                    <strong>Phone:</strong> {{ candidate.phone }}<br>
                    <strong>Applied For:</strong> <a href="{% url 'job_detail' candidate.job.id %}">{{ candidate.job.title }}</a><br>
                    <strong>Application Date:</strong> {{ candidate.created_at|date:"F d, Y" }}
                </p>
                
                <div class="d-grid gap-2 mt-4">
                    <a href="{{ candidate.resume.url }}" class="btn btn-outline-primary" target="_blank">
                        <i class="bi bi-file-text"></i> View Resume
                    </a>
                    <a href="{% url 'parse_resume' candidate.id %}" class="btn btn-outline-secondary">
                        <i class="bi bi-magic"></i> Parse Resume
                    </a>
                    <a href="{% url 'schedule_interview' candidate.id candidate.job.id %}" class="btn btn-success">
                        <i class="bi bi-calendar-event"></i> Schedule Interview
                    </a>
                    <a href="{% url 'send_email' candidate.id %}" class="btn btn-info">
                        <i class="bi bi-envelope"></i> Send Email
                    </a>
                    <a href="{% url 'add_note' candidate.id %}" class="btn btn-secondary">
                        <i class="bi bi-journal-plus"></i> Add Note
                    </a>
                </div>
            </div>
            <div class="card-footer">
                <h5>Current Stage</h5>
                <div class="progress" style="height: 30px;">
                    {% for stage in stages %}
                        {% if stage == candidate.stage %}
                            <div class="progress-bar bg-success" style="width: {{ forloop.counter|divisibleby:8|yesno:'100,14.28' }}%">
                                {{ candidate.get_stage_display }}
                            </div>
                        {% elif stage == 'rejected' and candidate.stage == 'rejected' %}
                            <div class="progress-bar bg-danger" style="width: 100%">
                                Rejected
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="mt-3">
                    <form method="post" action="{% url 'update_stage' candidate.id %}">
                        {% csrf_token %}
                        <div class="input-group">
                            <select name="stage" class="form-select" id="change-stage">
                                <option value="new" {% if candidate.stage == 'new' %}selected{% endif %}>New</option>
                                <option value="screening" {% if candidate.stage == 'screening' %}selected{% endif %}>Screening</option>
                                <option value="interview" {% if candidate.stage == 'interview' %}selected{% endif %}>Interview</option>
                                <option value="technical" {% if candidate.stage == 'technical' %}selected{% endif %}>Technical Assessment</option>
                                <option value="final" {% if candidate.stage == 'final' %}selected{% endif %}>Final Interview</option>
                                <option value="offer" {% if candidate.stage == 'offer' %}selected{% endif %}>Offer</option>
                                <option value="hired" {% if candidate.stage == 'hired' %}selected{% endif %}>Hired</option>
                                <option value="rejected" {% if candidate.stage == 'rejected' %}selected{% endif %}>Rejected</option>
                            </select>
                            <button type="submit" class="btn btn-primary">Update Stage</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <ul class="nav nav-tabs mb-3" id="candidateTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-selected="true">Profile</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="skills-tab" data-bs-toggle="tab" data-bs-target="#skills" type="button" role="tab" aria-selected="false">Skills</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="education-tab" data-bs-toggle="tab" data-bs-target="#education" type="button" role="tab" aria-selected="false">Education</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="experience-tab" data-bs-toggle="tab" data-bs-target="#experience" type="button" role="tab" aria-selected="false">Experience</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab" aria-selected="false">Notes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="interviews-tab" data-bs-toggle="tab" data-bs-target="#interviews" type="button" role="tab" aria-selected="false">Interviews</button>
            </li>
        </ul>
        
        <div class="tab-content" id="candidateTabsContent">
            <!-- Profile Tab -->
            <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <div class="card">
                    <div class="card-header">
                        <h4>Candidate Profile</h4>
                    </div>
                    <div class="card-body">
                        {% if candidate.cover_letter %}
                            <h5>Cover Letter</h5>
                            <div class="p-3 bg-light mb-4 rounded">
                                {{ candidate.cover_letter|linebreaks }}
                            </div>
                        {% endif %}
                        
                        <h5>Application Details</h5>
                        <table class="table">
                            <tr>
                                <th style="width: 150px;">Full Name</th>
                                <td>{{ candidate.first_name }} {{ candidate.last_name }}</td>
                            </tr>
                            <tr>
                                <th>Email</th>
                                <td>{{ candidate.email }}</td>
                            </tr>
                            <tr>
                                <th>Phone</th>
                                <td>{{ candidate.phone|default:"Not provided" }}</td>
                            </tr>
                            <tr>
                                <th>Applied For</th>
                                <td>{{ candidate.job.title }}</td>
                            </tr>
                            <tr>
                                <th>Department</th>
                                <td>{{ candidate.job.department.name }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Skills Tab -->
            <div class="tab-pane fade" id="skills" role="tabpanel" aria-labelledby="skills-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>Skills</h4>
                        <a href="{% url 'add_skill' candidate.id %}" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus"></i> Add Skill
                        </a>
                    </div>
                    <div class="card-body">
                        {% if candidate.skills.all %}
                            <div class="row">
                                {% for skill in candidate.skills.all %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <h5 class="card-title">{{ skill.skill }}</h5>
                                                <p class="card-text">{{ skill.years_experience }} years of experience</p>
                                                <div class="text-end">
                                                    <a href="{% url 'edit_skill' skill.id %}" class="btn btn-sm btn-outline-secondary">Edit</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">No skills recorded yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Education Tab -->
            <div class="tab-pane fade" id="education" role="tabpanel" aria-labelledby="education-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>Education</h4>
                        <a href="{% url 'add_education' candidate.id %}" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus"></i> Add Education
                        </a>
                    </div>
                    <div class="card-body">
                        {% if candidate.education.all %}
                            <div class="timeline">
                                {% for edu in candidate.education.all %}
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <h5 class="card-title">{{ edu.degree }}</h5>
                                                    <h6 class="card-subtitle mb-2 text-muted">{{ edu.institution }}</h6>
                                                    <p class="card-text">
                                                        {% if edu.field_of_study %}{{ edu.field_of_study }}<br>{% endif %}
                                                        {{ edu.from_date|date:"M Y" }} - 
                                                        {% if edu.to_date %}{{ edu.to_date|date:"M Y" }}{% else %}Present{% endif %}
                                                    </p>
                                                </div>
                                                <div>
                                                    <a href="{% url 'edit_education' edu.id %}" class="btn btn-sm btn-outline-secondary">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">No education history recorded yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Experience Tab -->
            <div class="tab-pane fade" id="experience" role="tabpanel" aria-labelledby="experience-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>Work Experience</h4>
                        <a href="{% url 'add_experience' candidate.id %}" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus"></i> Add Experience
                        </a>
                    </div>
                    <div class="card-body">
                        {% if candidate.experience.all %}
                            <div class="timeline">
                                {% for exp in candidate.experience.all %}
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <h5 class="card-title">{{ exp.title }}</h5>
                                                    <h6 class="card-subtitle mb-2 text-muted">{{ exp.company }}</h6>
                                                    <p class="card-text">
                                                        {{ exp.from_date|date:"M Y" }} - 
                                                        {% if exp.to_date %}{{ exp.to_date|date:"M Y" }}{% else %}Present{% endif %}
                                                    </p>
                                                    <p class="card-text">{{ exp.description|linebreaks }}</p>
                                                </div>
                                                <div>
                                                    <a href="{% url 'edit_experience' exp.id %}" class="btn btn-sm btn-outline-secondary">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">No work experience recorded yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Notes Tab -->
            <div class="tab-pane fade" id="notes" role="tabpanel" aria-labelledby="notes-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>Notes</h4>
                        <a href="{% url 'add_note' candidate.id %}" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus"></i> Add Note
                        </a>
                    </div>
                    <div class="card-body">
                        {% if candidate.notes.all %}
                            {% for note in candidate.notes.all %}
                                <div class="card mb-3">
                                    <div class="card-header bg-light d-flex justify-content-between">
                                        <span>
                                            <strong>{{ note.created_by.get_full_name|default:note.created_by.username }}</strong>
                                            <span class="text-muted">{{ note.created_at|date:"M d, Y" }} at {{ note.created_at|time:"H:i" }}</span>
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">{{ note.content|linebreaks }}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No notes recorded yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Interviews Tab -->
            <div class="tab-pane fade" id="interviews" role="tabpanel" aria-labelledby="interviews-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>Interviews</h4>
                        <a href="{% url 'schedule_interview' candidate.id candidate.job.id %}" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus"></i> Schedule Interview
                        </a>
                    </div>
                    <div class="card-body">
                        {% if candidate.interviews.all %}
    {% for interview in candidate.interviews.all %}
        <div class="card mb-3">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Interview for {{ interview.job.title }}</h5>
                    <span class="badge {% if interview.status == 'scheduled' %}bg-warning{% elif interview.status == 'completed' %}bg-success{% elif interview.status == 'cancelled' %}bg-danger{% else %}bg-secondary{% endif %}">
                        {{ interview.get_status_display }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <p><strong>Date & Time:</strong> {{ interview.scheduled_at|date:"F d, Y" }} at {{ interview.scheduled_at|time:"H:i" }}</p>
                <p><strong>Duration:</strong> {{ interview.duration }} minutes</p>
                
                {% if interview.interviewers.all %}
                    <p><strong>Interviewers:</strong> 
                    {% for interviewer in interview.interviewers.all %}
                        {{ interviewer.get_full_name|default:interviewer.username }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                    </p>
                {% endif %}
                
                {% if interview.location %}
                    <p><strong>Location:</strong> {{ interview.location }}</p>
                {% endif %}
                
                {% if interview.notes %}
                    <h6>Notes:</h6>
                    <div class="p-3 bg-light rounded">
                        {{ interview.notes|linebreaks }}
                    </div>
                {% endif %}
            </div>
        </div>
    {% endfor %}
{% else %}
    <p class="text-muted">No interviews scheduled yet.</p>
{% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}